<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Font Identifier Tool</title>

  <!-- Cropper.js -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }

    #drop-zone {
      border: 2px dashed #aaa;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      margin-top: 1rem;
      background-color: #f9f9f9;
      transition: background-color 0.2s ease;
    }

    #drop-zone.dragover {
      background-color: #e3f2fd;
    }

    img {
      max-width: 100%;
      max-height: 500px;
      display: block;
      margin-top: 1rem;
    }

    #results {
      margin-top: 2rem;
    }

    .font-result {
      margin-bottom: 2rem;
    }

    button {
      margin-top: 1rem;
      margin-right: 1rem;
    }

    #crop-data {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Font Identifier Tool</h1>

  <div id="drop-zone">
    <p>Drag & drop an image here, or click to upload</p>
    <input type="file" id="image-upload" accept="image/*" hidden />
  </div>

  <img id="preview" src="" alt="Image Preview" />

  <div>
    <button id="reset-button" type="button">Reset</button>
    <form id="upload-form" style="display:inline;">
      <button type="submit">Crop & Identify Font</button>
    </form>
  </div>

  <div id="crop-data"></div>
  <div id="results"></div>

  <!-- Cropper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script>
    const form = document.getElementById('upload-form');
    const preview = document.getElementById('preview');
    const resultsDiv = document.getElementById('results');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('image-upload');
    const resetButton = document.getElementById('reset-button');
    const cropDataDisplay = document.getElementById('crop-data');

    let cropper = null;

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        fileInput.files = e.dataTransfer.files;
        handleFile(file);
      }
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    });

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;

        if (cropper) {
          cropper.destroy();
        }

        preview.onload = () => {
          cropper = new Cropper(preview, {
            aspectRatio: NaN,
            viewMode: 1,
            zoomable: true,
            scalable: true,
            crop: (event) => {
              const data = event.detail;
              cropDataDisplay.textContent = `Crop Area â€” x: ${Math.round(data.x)}, y: ${Math.round(data.y)}, width: ${Math.round(data.width)}, height: ${Math.round(data.height)}`;
            }
          });
        };
      };
      reader.readAsDataURL(file);
    }

    resetButton.addEventListener('click', () => {
      preview.src = '';
      resultsDiv.innerHTML = '';
      cropDataDisplay.textContent = '';
      fileInput.value = '';
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (!cropper) return;

      resultsDiv.innerHTML = 'Processing...';

      const canvas = cropper.getCroppedCanvas();

      canvas.toBlob(async function (blob) {
        const formData = new FormData();
        formData.append('file', blob, 'cropped.png');

        try {
          const response = await fetch('/identify-font', {
            method: 'POST',
            body: formData,
          });

          const data = await response.json();
          resultsDiv.innerHTML = '<h2>Matching Fonts</h2>';

          if (data.matches) {
            data.matches.forEach(font => {
              const linkTag = document.createElement('link');
              linkTag.rel = 'stylesheet';
              linkTag.href = `https://fonts.googleapis.com/css2?family=${font.name.replace(/ /g, '+')}&display=swap`;
              document.head.appendChild(linkTag);

              const fontBlock = document.createElement('div');
              fontBlock.className = 'font-result';
              fontBlock.innerHTML = `
                <strong>${font.name}</strong><br>
                <span style="font-family: '${font.name}', sans-serif; font-size: 24px;">${data.text}</span><br>
                <a href="${font.url}" target="_blank">Download</a>
              `;
              resultsDiv.appendChild(fontBlock);
            });
          } else {
            resultsDiv.innerHTML += `<p><strong>Text Detected:</strong> ${data.text}</p>`;
          }
        } catch (err) {
          resultsDiv.innerHTML = 'Error identifying font.';
          console.error(err);
        }
      }, 'image/png');
    });
  </script>
</body>
</html>